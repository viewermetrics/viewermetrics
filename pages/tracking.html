<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viewer Metrics - Tracking</title>
    <link rel="stylesheet" href="../ui/styles.css">
    <link rel="stylesheet" href="tracking.css">
</head>

<body>
    <div class="tvm-tracking-container">
        <header class="tvm-tracking-header">
            <div class="tvm-header-content">
                <h1 id="tvm-tracking-title">Viewer Metrics</h1>
                <div class="tvm-header-actions">
                    <button id="tvm-switch-channel-btn" class="tvm-btn tvm-btn-primary" data-i18n="switchChannel"></button>
                    <button id="tvm-close-btn" class="tvm-btn tvm-btn-secondary" data-i18n="stopTracking"></button>
                </div>
            </div>
        </header>

        <main class="tvm-tracking-main">
            <div id="tvm-tracking-content">
                <div class="tvm-container">
                    <div class="tvm-header">
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <div style="display: flex; gap: 10px; align-items: center; flex: 1;">
                                <button id="tvm-history-mode-btn" class="tvm-tab tvm-history-mode-tab"
                                    style="display: none;" data-i18n="btnLive">
                                </button>
                                <div id="tvm-history-start-date" class="tvm-history-start-date" style="display: none;">
                                </div>
                                <div id="tvm-actual-viewers-stats"
                                    style="display: none; font-size: 18px; font-weight: 600; color: #adadb8;">
                                    <span data-i18n="MaxPossibleViewers"></span>
                                    <span id="tvm-actual-viewers" style="color:white">0</span><span
                                        id="tvm-total-viewers-ratio" style="display: none;">0</span>
                                    (<span id="tvm-viewer-percentage" style="font-weight: 700;">0%</span>)
                                </div>
                            </div>

                            <div class="tvm-bot-calc-toggle"
                                style="position: absolute; left: 50%; transform: translateX(-50%); display: none;">
                                <button class="tvm-bot-calc-btn tvm-bot-calc-active" data-calc-type="0" data-i18n="btnCalcNormal"></button>
                                <button class="tvm-bot-calc-btn" data-calc-type="1" data-i18n="btnCalcHigh"></button>
                            </div>

                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div class="tvm-tabs" id="tvm-tabs" style="display: none;">
                                    <button class="tvm-tab tvm-tab-active" data-tab="graphs" data-i18n="btnTabGraphs"></button>
                                    <button class="tvm-tab" data-tab="viewers" data-i18n="btnTabViewers"></button>
                                    <button class="tvm-tab" data-tab="settings" data-i18n="btnTabSettings"></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tvm-content" class="tvm-content" style="display: none;">
                        <div class="tvm-stats">
                            <div class="tvm-stat">
                                <span class="tvm-stat-label" data-i18n="labelStatViewers"></span>
                                <span id="tvm-viewers" class="tvm-stat-value">0</span>
                            </div>
                            <div class="tvm-stat">
                                <span class="tvm-stat-label" data-i18n="labelStatAuthenticated"></span>
                                <span id="tvm-authenticated-users" class="tvm-stat-value">0</span>
                            </div>
                            <div class="tvm-stat">
                                <span class="tvm-stat-label" data-i18n="labelStatAuthenticatedUsers"></span>
                                <span id="tvm-non-bots" class="tvm-stat-value">0</span>
                            </div>
                            <div class="tvm-stat">
                                <span class="tvm-stat-label" data-i18n="labelStatAuthenticatedBots"></span>
                                <span id="tvm-bots" class="tvm-stat-value">0</span>
                            </div>
                            <div class="tvm-stat tvm-stat-scanned">
                                <span class="tvm-stat-label" data-i18n="labelStatScanned"></span>
                                <div id="tvm-scanned-breakdown" class="tvm-scanned-breakdown">
                                    <div class="tvm-scanned-line"><span data-i18n="labelScannedBots"></span>: <span id="tvm-bots-count">0</span></div>
                                    <div class="tvm-scanned-line"><span data-i18n="labelScannedTotal"></span>: <span id="tvm-users-count">0</span></div>
                                </div>
                            </div>
                            <div class="tvm-stat">
                                <span id="tvm-api-data" class="tvm-stat-value"
                                    style="font-size: 14px; line-height: 1.4;">
                                    <span data-i18n="labelStatUsersFound"></span>: <span id="tvm-authenticated">0</span><br>
                                    <span data-i18n="labelStatPending"></span>: <span id="tvm-pending">0</span><br>
                                    <span data-i18n="labelStatAvailable"></span>: <span id="tvm-api-calls">0/5000</span>
                                </span>
                            </div>
                        </div>

                        <!-- Tab Content Container -->
                        <div class="tvm-tab-content">
                            <!-- Graphs Tab -->
                            <div id="tvm-tab-graphs" class="tvm-tab-panel tvm-tab-panel-active">
                                <div id="tvm-graphs-wrapper" class="tvm-graphs-compact">
                                    <div class="tvm-graph-container" style="padding-right: 5px;">
                                        <canvas id="tvm-graph"></canvas>
                                        <div class="tvm-watermark-left">@viewermetrics</div>
                                        <div id="tvm-start-time" class="tvm-start-time">--</div>
                                        <div class="tvm-stream-name"></div>
                                        <div class="tvm-smooth-lines-control" id="tvm-smooth-lines-control">
                                            <div class="tvm-smooth-lines-label" data-i18n="labelSmoothSmoothLines"></div>
                                            <label class="tvm-smooth-lines-toggle">
                                                <input type="checkbox" id="tvm-smooth-lines-toggle" checked>
                                                <span class="tvm-smooth-lines-slider"></span>
                                            </label>
                                        </div>
                                        <div class="tvm-skip-entries-control" id="tvm-skip-entries-control">
                                            <div class="tvm-skip-entries-header">
                                                <span class="tvm-skip-entries-label" data-i18n="labelSkipEntriesSkip"></span>
                                                <span class="tvm-skip-entries-value"
                                                    id="tvm-skip-entries-value">0</span>
                                            </div>
                                            <input type="range" id="tvm-skip-entries-slider" min="0" max="20" value="0"
                                                step="1">
                                        </div>
                                    </div>

                                    <div class="tvm-graph-container">
                                        <canvas id="tvm-creation-graph"></canvas>
                                        <div class="tvm-creation-left" id="tvm-creation-title">@viewermetrics</div>
                                        <div class="tvm-creation-stats" id="tvm-creation-stats">
                                            <span id="tvm-creation-percentage">0%</span> <span
                                                id="tvm-creation-percentage-label">2020+</span>
                                        </div>
                                        <div class="tvm-bot-threshold-control" id="tvm-bot-threshold-control">
                                            <div class="tvm-bot-threshold-label" data-i18n="labelBotThreshold"></div>
                                            <input type="range" class="tvm-bot-threshold-slider"
                                                id="tvm-bot-threshold-slider" min="0" max="100" value="50" disabled>
                                            <div class="tvm-bot-threshold-footer">
                                                <div class="tvm-bot-threshold-value" id="tvm-bot-threshold-value">Auto
                                                </div>
                                                <button class="tvm-bot-threshold-lock" id="tvm-bot-threshold-lock"
                                                    title="Unlock to override calculated threshold">
                                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                        <path
                                                            d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Heatmap Graph -->
                                <div class="tvm-heatmap-wrapper">
                                    <div style="display: flex; gap: 20px; align-items: flex-start;">
                                        <div class="tvm-heatmap-container" id="tvm-heatmap-container">
                                            <canvas id="tvm-heatmap-graph"></canvas>
                                        </div>
                                        <div class="tvm-heatmap-stats" id="tvm-heatmap-stats">
                                            <div
                                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                                <h4 id="tvm-heatmap-stats-title" style="margin: 0;" data-i18n="labelHeatmapViewerDuration">
                                                </h4>
                                                <button id="tvm-heatmap-stats-reset" class="tvm-btn tvm-btn-small"
                                                    style="display: none; padding: 4px 8px; font-size: 11px;" data-i18n="btnHeatmapReset"></button>
                                            </div>
                                            <div class="tvm-heatmap-stats-content" id="tvm-heatmap-stats-content">
                                                <!-- Stats will be populated here -->
                                            </div>
                                        </div>
                                        <div class="tvm-bot-duration-stats" id="tvm-bot-duration-stats">
                                            <div style="margin-bottom: 12px;">
                                                <h4 style="margin: 0;" data-i18n="labelDurationStatsBotDuration"></h4>
                                            </div>
                                            <div class="tvm-heatmap-stats-content" id="tvm-bot-duration-stats-content">
                                                <!-- Bot stats will be populated here -->
                                            </div>
                                        </div>
                                        <div class="tvm-stream-stats" id="tvm-stream-stats">
                                            <h4 style="margin: 0 0 12px 0;" data-i18n="labelStreamStatsSummary"></h4>
                                            <div class="tvm-stream-stats-content" id="tvm-stream-stats-content">
                                                <!-- Stream stats will be populated here -->
                                            </div>
                                            <div class="tvm-stream-stats-indicator"
                                                style="display: flex; align-items: center; gap: 8px;">
                                                <input type="range" id="tvm-summary-skip-slider" min="0" max="20"
                                                    value="5"
                                                    style="width: 80px; height: 4px; cursor: pointer; accent-color: #9147ff;">
                                                <span id="tvm-summary-skip-label" data-i18n="labelStreamStatsAfter"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Viewers Tab -->
                            <div id="tvm-tab-viewers" class="tvm-tab-panel">
                                <div class="tvm-viewers-container" style="display: flex; gap: 15px; margin-top: 20px;">
                                    <!-- Viewer Detail Panel -->
                                    <div id="tvm-viewer-detail-panel" class="tvm-viewer-detail-panel"
                                        style="display: none;">
                                        <div class="tvm-panel-header">
                                            <h3 class="tvm-panel-title" id="tvm-panel-title"></h3>
                                            <button class="tvm-panel-close">&times;</button>
                                        </div>
                                        <div class="tvm-panel-body" id="tvm-panel-body"></div>
                                    </div>

                                    <div class="tvm-viewer-list" style="flex: 1; margin-top: 0;">
                                        <div class="tvm-pagination tvm-pagination-top" id="tvm-pagination-top"
                                            style="display: none; margin-bottom: 10px;">
                                            <button id="tvm-prev-top" class="tvm-btn tvm-btn-small" data-i18n="btnViewerListPrevious"></button>
                                            <span id="tvm-page-info-top"><span data-i18n="labelPageiInfoPageA"></span> 1 <span data-i18n="labelPageiInfoPageB"></span> 1</span>
                                            <button id="tvm-next-top" class="tvm-btn tvm-btn-small" data-i18n="btnViewerListNext"></button>
                                        </div>

                                        <div class="tvm-list-header">
                                            <input type="text" id="tvm-search" placeholder="Search viewers..."
                                                class="tvm-search">
                                            <select id="tvm-sort" class="tvm-select">
                                                <option value="timeInStream" data-i18n="labelSortSortByTime"></option>
                                                <option value="username" data-i18n="labelSortByUsername"></option>
                                                <option value="createdAt" data-i18n="labelSortByCreatedDate"></option>
                                                <option value="accountsOnSameDay" data-i18n="labelSortBySameDayCount"></option>
                                            </select>
                                        </div>

                                        <div class="tvm-list-content" id="tvm-list-content"
                                            style="max-height: none; overflow: visible;">
                                            <p class="tvm-empty" data-i18n="labelListContentEmptyA"></p>
                                        </div>

                                        <div class="tvm-pagination" id="tvm-pagination" style="display: none;">
                                            <button id="tvm-prev" class="tvm-btn tvm-btn-small" data-i18n="btnViewerListPrevious"></button>
                                            <span id="tvm-page-info"><span data-i18n="labelPageiInfoPageA"></span> 1 <span data-i18n="labelPageiInfoPageB"></span> 1</span>
                                            <button id="tvm-next" class="tvm-btn tvm-btn-small" data-i18n="btnViewerListNext"></button>
                                        </div>
                                    </div>

                                    <!-- Bot Stats Panels -->
                                    <div class="tvm-bot-stats-panels"
                                        style="width: 240px; display: flex; flex-direction: column; gap: 15px;">
                                        <!-- Top 10 Months Panel -->
                                        <div class="tvm-bot-panel">
                                            <div class="tvm-bot-panel-header">
                                                <h3 class="tvm-bot-panel-title" data-i18n="labelBotStatsMonths"></h3>
                                                <button id="tvm-toggle-all-months" class="tvm-toggle-btn"
                                                    title="Toggle between Top 10 and All Months" data-i18n="btnBotStatsShowAll"></button>
                                            </div>
                                            <div id="tvm-clear-date-filter-container"
                                                style="display: none; margin-bottom: 8px;"></div>
                                            <div id="tvm-top-months-list" class="tvm-bot-list">
                                                <p class="tvm-empty" data-i18n="labelNoDataAvailable"></p>
                                            </div>
                                        </div>

                                        <!-- Top 25 Same Day Counts Panel -->
                                        <div class="tvm-bot-panel">
                                            <div class="tvm-bot-panel-header">
                                                <h3 class="tvm-bot-panel-title" data-i18n="labelBotStatsTop25Same"></h3>
                                            </div>
                                            <div id="tvm-top-days-list" class="tvm-bot-list">
                                                <p class="tvm-empty" data-i18n="labelNoDataAvailable"></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Settings Tab -->
                            <div id="tvm-tab-settings" class="tvm-tab-panel">
                                <div class="tvm-columns"
                                    style="display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap;">
                                    <!-- Left Column: Settings (75% width) -->
                                    <div class="tvm-settings-column" style="flex: 3; min-width: 400px; max-width: 75%;">
                                        <div class="tvm-settings" style="margin-bottom: 20px; margin-top: 0;">
                                            <div class="tvm-settings-panel" style="margin-top: 0;">
                                                <div style="margin-bottom: 20px;">
                                                    <label
                                                        style="display: flex; align-items: flex-start; gap: 8px; margin-bottom: 8px;">
                                                        <input type="checkbox" id="tvm-auto-adjust-request-interval">
                                                        <div>
                                                            <span data-i18n="labelAutoAdjustRequest"></span>
                                                            <div style="font-size: 12px; color: #999; margin-top: 5px;" data-i18n="labelAutoAdjustRequestSub">
                                                            </div>
                                                            <div id="tvm-effective-request-interval"
                                                                style="font-size: 12px; color: #00ff88; margin-top: 5px; font-weight: bold; display: none;">
                                                                <span data-i18n="labelCurrentEffective"></span>: <span id="tvm-effective-request-interval-value">--</span>
                                                                <span data-i18n="labelCurrentEffectiveSeconds"></span>
                                                            </div>
                                                        </div>
                                                    </label>
                                                    <div style="margin-left: 24px;">
                                                        <label style="display: block; margin-bottom: 4px;"><span data-i18n="labelRequestInterval"></span>:</label>
                                                        <input type="number" id="tvm-interval" min="1" max="60"
                                                            value="5" style="width: 120px;">
                                                    </div>
                                                </div>

                                                <div style="margin-bottom: 20px;">
                                                    <label
                                                        style="display: flex; align-items: flex-start; gap: 8px; margin-bottom: 8px;">
                                                        <input type="checkbox" id="tvm-auto-adjust-timeout">
                                                        <div>
                                                            <span data-i18n="labelAutoAdjustTimeout"></span>
                                                            <div style="font-size: 12px; color: #999; margin-top: 5px;" data-i18n="labelAutoAdjustTimeoutSub"></div>
                                                            <div id="tvm-effective-timeout"
                                                                style="font-size: 12px; color: #00ff88; margin-top: 5px; font-weight: bold; display: none;">
                                                                <span data-i18n="labelCurrentEffectiveTimeout"></span>:<span id="tvm-effective-timeout-value">--</span> <span data-i18n="labelCurrentEffectiveTimeoutSub"></span>
                                                            </div>
                                                        </div>
                                                    </label>
                                                    <div style="margin-left: 24px;">
                                                        <label style="display: block; margin-bottom: 4px;" data-i18n="labelTimeoutDuration"></label>
                                                        <input type="number" id="tvm-timeout" min="5" max="60"
                                                            value="10" style="width: 120px;">
                                                    </div>
                                                </div>

                                                <div style="margin-bottom: 20px;">
                                                    <label style="display: flex; align-items: flex-start; gap: 8px;">
                                                        <input type="checkbox" id="tvm-auto-pause-graphs">
                                                        <div>
                                                            <span data-i18n="labelAutoPauseGraphsWhen"></span>
                                                            <div style="font-size: 12px; color: #999; margin-top: 5px;" data-i18n="labelAutoPauseGraphsWhenSub"></div>
                                                        </div>
                                                    </label>
                                                </div>

                                                <div style="margin-bottom: 20px;">
                                                    <label style="display: flex; align-items: flex-start; gap: 8px;">
                                                        <input type="checkbox" id="tvm-clean-graph-zero-data">
                                                        <div>
                                                            <span data-i18n="labelCleanGraphData"></span>
                                                            <div style="font-size: 12px; color: #999; margin-top: 5px;" data-i18n="labelCleanGraphDataSub"></div>
                                                        </div>
                                                    </label>
                                                </div>

                                                <div style="margin-bottom: 20px;">
                                                    <label style="display: block; margin-bottom: 8px;">
                                                        <span data-i18n="labelHistoryRetention"></span>
                                                        <div style="font-size: 12px; color: #999; margin-top: 5px;" data-i18n="labelHistoryRetentionSub"></div>
                                                    </label>
                                                    <input type="number" id="tvm-history-retention" min="1" max="72"
                                                        value="12" style="width: 120px;">
                                                </div>

                                                <div style="display: flex; gap: 10px; align-items: center;">
                                                    <button id="tvm-reset-settings" class="tvm-btn tvm-btn-secondary" data-i18n="btnResetToDefaults"></button>
                                                    <button id="tvm-save-settings" class="tvm-btn tvm-btn-primary" data-i18n="btnSaveSettings"></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right Column: Debug Info (25% width) -->
                                    <div class="tvm-debug-column" style="flex: 1; min-width: 200px; max-width: 25%;">
                                        <div class="tvm-debug" style="font-size: 12px; color: #666;">
                                            <div id="tvm-debug-panel"
                                                style="padding: 10px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                                                <div id="tvm-debug-content" data-i18n="labelDebugLoading"></div>
                                            </div>
                                        </div>

                                        <!-- Export Panel - Tracking Data -->
                                        <div class="tvm-settings" style="margin-top: 20px;">
                                            <div class="tvm-settings-panel">
                                                <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #efeff1;" data-i18n="labelExportTrackingData"></h3>
                                                <div style="font-size: 12px; color: #adadb8; margin-bottom: 15px;" data-i18n="labelExportTrackingDataSub"></div>
                                                <div
                                                    style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                                                    <button id="tvm-export-csv" class="tvm-btn tvm-btn-primary" data-i18n="btnCsv"></button>
                                                    <button id="tvm-export-xml" class="tvm-btn tvm-btn-primary" data-i18n="btnXml"></button>
                                                    <button id="tvm-export-sql" class="tvm-btn tvm-btn-primary" data-i18n="btnSql"></button>
                                                    <button id="tvm-export-json" class="tvm-btn tvm-btn-primary" data-i18n="btnJson"></button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Export Panel - Viewer Graph -->
                                        <div class="tvm-settings" style="margin-top: 20px;">
                                            <div class="tvm-settings-panel">
                                                <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #efeff1;" data-i18n="labelExportViewerGraphData"></h3>
                                                <div style="font-size: 12px; color: #adadb8; margin-bottom: 15px;" data-i18n="labelExportViewerGraphDataSub"></div>
                                                <div
                                                    style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                                                    <button id="tvm-export-graph-csv" class="tvm-btn tvm-btn-primary" data-i18n="btnCsv"></button>
                                                    <button id="tvm-export-graph-xml" class="tvm-btn tvm-btn-primary" data-i18n="btnXml"></button>
                                                    <button id="tvm-export-graph-sql" class="tvm-btn tvm-btn-primary" data-i18n="btnSql"></button>
                                                    <button id="tvm-export-graph-json" class="tvm-btn tvm-btn-primary" data-i18n="btnJson"></button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Export/Import Panel - Full State -->
                                        <div class="tvm-settings" style="margin-top: 20px;">
                                            <div class="tvm-settings-panel">
                                                <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #efeff1;" data-i18n="labelSessionSave"></h3>
                                                <div style="font-size: 12px; color: #adadb8; margin-bottom: 15px;" data-i18n="labelSessionSaveSub"></div>
                                                <div
                                                    style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                                                    <button id="tvm-export-full-state" class="tvm-btn tvm-btn-primary" data-i18n="btnSessionSave"></button>
                                                    <button id="tvm-import-full-state" class="tvm-btn tvm-btn-secondary" data-i18n="btnSessionLoad"></button>
                                                    <input type="file" id="tvm-import-file-input" accept=".json"
                                                        style="display: none;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../content/core/i18n.js"></script>
    <script src="../lib/chart.umd.min.js"></script>
    <script src="../lib/chartjs-adapter-date-fns.min.js"></script>
    <script src="../shared/timeout-utils.js"></script>
    <script src="../content/core/settings-manager.js"></script>
    <script src="../content/core/error-handler.js"></script>
    <script src="../content/services/api-client.js"></script>
    <script src="../content/services/export-manager.js"></script>
    <script src="../content/services/enhanced-data-manager.js"></script>
    <script src="../content/utils/format-utils.js"></script>
    <script src="../content/utils/dom-utils.js"></script>
    <script src="../content/utils/color-utils.js"></script>
    <script src="../content/ui/html-templates.js"></script>
    <script src="../content/charts/chart-utils.js"></script>
    <script src="../content/charts/main-chart.js"></script>
    <script src="../content/charts/creation-chart.js"></script>
    <script src="../content/charts/heatmap-chart.js"></script>
    <script src="../content/charts/chart-manager.js"></script>
    <script src="../content/managers/stats-manager.js"></script>
    <script src="../content/managers/viewer-list-manager.js"></script>
    <script src="../content/managers/debug-manager.js"></script>
    <script src="../content/ui/viewer-detail-manager.js"></script>
    <script src="../content/ui/tab-manager.js"></script>
    <script src="../content/ui/settings-ui.js"></script>
    <script src="../content/ui/ui-manager.js"></script>
    <script src="tracking.js"></script>
</body>

</html>