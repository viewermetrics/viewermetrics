<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viewer Metrics - Tracking</title>
    <link rel="stylesheet" href="../ui/styles.css">
    <link rel="stylesheet" href="tracking.css">
</head>

<body>
    <div class="tvm-tracking-container">
        <header class="tvm-tracking-header">
            <div class="tvm-header-content">
                <h1 id="tvm-tracking-title">Viewer Metrics</h1>
                <div class="tvm-header-actions">
                    <button id="tvm-switch-channel-btn" class="tvm-btn tvm-btn-primary">Switch Channel</button>
                    <button id="tvm-close-btn" class="tvm-btn tvm-btn-secondary">Close & Stop Tracking</button>
                </div>
            </div>
        </header>

        <main class="tvm-tracking-main">
            <div id="tvm-tracking-content">
                <div class="tvm-container">
                    <div class="tvm-header">
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <div style="display: flex; gap: 10px; align-items: center; flex: 1;">
                                <button id="tvm-history-mode-btn" class="tvm-tab tvm-history-mode-tab"
                                    style="display: none;">
                                    Live
                                </button>
                                <div id="tvm-history-start-date" class="tvm-history-start-date" style="display: none;">
                                </div>
                                <div id="tvm-actual-viewers-stats"
                                    style="display: none; font-size: 18px; font-weight: 600; color: #adadb8;">
                                    Maximum possible viewers if all bots active
                                    <span id="tvm-actual-viewers" style="color:white">0</span><span
                                        id="tvm-total-viewers-ratio" style="display: none;">0</span>
                                    (<span id="tvm-viewer-percentage" style="font-weight: 700;">0%</span>)
                                </div>
                            </div>

                            <div class="tvm-bot-calc-toggle"
                                style="position: absolute; left: 50%; transform: translateX(-50%); display: none;">
                                <button class="tvm-bot-calc-btn tvm-bot-calc-active" data-calc-type="0">Normal</button>
                                <button class="tvm-bot-calc-btn" data-calc-type="1">High Churn</button>
                            </div>

                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div class="tvm-tabs" id="tvm-tabs" style="display: none;">
                                    <button class="tvm-tab tvm-tab-active" data-tab="graphs">Graphs</button>
                                    <button class="tvm-tab" data-tab="viewers">Viewers</button>
                                    <button class="tvm-tab" data-tab="settings">Settings</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tvm-content" class="tvm-content" style="display: none;">
                        <div class="tvm-stats">
                            <div class="tvm-stat">
                                <span class="tvm-stat-label">Viewers</span>
                                <span id="tvm-viewers" class="tvm-stat-value">0</span>
                            </div>
                            <div class="tvm-stat">
                                <span class="tvm-stat-label">Authenticated</span>
                                <span id="tvm-authenticated-users" class="tvm-stat-value">0</span>
                            </div>
                            <div class="tvm-stat">
                                <span class="tvm-stat-label">Authenticated Users</span>
                                <span id="tvm-non-bots" class="tvm-stat-value">0</span>
                            </div>
                            <div class="tvm-stat">
                                <span class="tvm-stat-label">Authenticated Bots</span>
                                <span id="tvm-bots" class="tvm-stat-value">0</span>
                            </div>
                            <div class="tvm-stat tvm-stat-scanned">
                                <span class="tvm-stat-label">Scanned</span>
                                <div id="tvm-scanned-breakdown" class="tvm-scanned-breakdown">
                                    <div class="tvm-scanned-line">Bots: <span id="tvm-bots-count">0</span></div>
                                    <div class="tvm-scanned-line">Total: <span id="tvm-users-count">0</span></div>
                                </div>
                            </div>
                            <div class="tvm-stat">
                                <span id="tvm-api-data" class="tvm-stat-value"
                                    style="font-size: 14px; line-height: 1.4;">
                                    Users Found: <span id="tvm-authenticated">0</span><br>
                                    Pending: <span id="tvm-pending">0</span><br>
                                    Available: <span id="tvm-api-calls">0/5000</span>
                                </span>
                            </div>
                        </div>

                        <!-- Tab Content Container -->
                        <div class="tvm-tab-content">
                            <!-- Graphs Tab -->
                            <div id="tvm-tab-graphs" class="tvm-tab-panel tvm-tab-panel-active">
                                <div id="tvm-graphs-wrapper" class="tvm-graphs-compact">
                                    <div class="tvm-graph-container" style="padding-right: 5px;">
                                        <canvas id="tvm-graph"></canvas>
                                        <div class="tvm-watermark-left">@viewermetrics</div>
                                        <div id="tvm-start-time" class="tvm-start-time">--</div>
                                        <div class="tvm-stream-name"></div>
                                        <div class="tvm-smooth-lines-control" id="tvm-smooth-lines-control">
                                            <div class="tvm-smooth-lines-label">Smooth Lines</div>
                                            <label class="tvm-smooth-lines-toggle">
                                                <input type="checkbox" id="tvm-smooth-lines-toggle" checked>
                                                <span class="tvm-smooth-lines-slider"></span>
                                            </label>
                                        </div>
                                        <div class="tvm-skip-entries-control" id="tvm-skip-entries-control">
                                            <div class="tvm-skip-entries-header">
                                                <span class="tvm-skip-entries-label">Skip</span>
                                                <span class="tvm-skip-entries-value"
                                                    id="tvm-skip-entries-value">0</span>
                                            </div>
                                            <input type="range" id="tvm-skip-entries-slider" min="0" max="20" value="0"
                                                step="1">
                                        </div>
                                    </div>

                                    <div class="tvm-graph-container">
                                        <canvas id="tvm-creation-graph"></canvas>
                                        <div class="tvm-creation-left" id="tvm-creation-title">@viewermetrics</div>
                                        <div class="tvm-creation-stats" id="tvm-creation-stats" style="display: none;">
                                        </div>
                                        <div class="tvm-bot-threshold-control" id="tvm-bot-threshold-control">
                                            <div class="tvm-bot-threshold-label">Bot Threshold</div>
                                            <input type="range" class="tvm-bot-threshold-slider"
                                                id="tvm-bot-threshold-slider" min="0" max="100" value="50" disabled>
                                            <div class="tvm-bot-threshold-footer">
                                                <div class="tvm-bot-threshold-value" id="tvm-bot-threshold-value">Auto
                                                </div>
                                                <button class="tvm-bot-threshold-lock" id="tvm-bot-threshold-lock"
                                                    title="Unlock to override calculated threshold">
                                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                                                        <path
                                                            d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Heatmap Graph -->
                                <div class="tvm-heatmap-wrapper">
                                    <div style="display: flex; gap: 20px; align-items: flex-start;">
                                        <div class="tvm-heatmap-container" id="tvm-heatmap-container">
                                            <canvas id="tvm-heatmap-graph"></canvas>
                                        </div>
                                        <div class="tvm-heatmap-stats" id="tvm-heatmap-stats">
                                            <div
                                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                                <h4 id="tvm-heatmap-stats-title" style="margin: 0;">Viewer Duration
                                                </h4>
                                                <button id="tvm-heatmap-stats-reset" class="tvm-btn tvm-btn-small"
                                                    style="display: none; padding: 4px 8px; font-size: 11px;">Reset</button>
                                            </div>
                                            <div class="tvm-heatmap-stats-content" id="tvm-heatmap-stats-content">
                                                <!-- Stats will be populated here -->
                                            </div>
                                        </div>
                                        <div class="tvm-bot-duration-stats" id="tvm-bot-duration-stats">
                                            <div style="margin-bottom: 12px;">
                                                <h4 style="margin: 0;">Bot Duration</h4>
                                            </div>
                                            <div class="tvm-heatmap-stats-content" id="tvm-bot-duration-stats-content">
                                                <!-- Bot stats will be populated here -->
                                            </div>
                                        </div>
                                        <div class="tvm-stream-stats" id="tvm-stream-stats">
                                            <h4 style="margin: 0 0 12px 0;">Summary</h4>
                                            <div class="tvm-stream-stats-content" id="tvm-stream-stats-content">
                                                <!-- Stream stats will be populated here -->
                                            </div>
                                            <div class="tvm-stream-stats-indicator"
                                                style="display: flex; align-items: center; gap: 8px;">
                                                <input type="range" id="tvm-summary-skip-slider" min="0" max="20"
                                                    value="5"
                                                    style="width: 80px; height: 4px; cursor: pointer; accent-color: #9147ff;">
                                                <span id="tvm-summary-skip-label">After 5m</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Viewers Tab -->
                            <div id="tvm-tab-viewers" class="tvm-tab-panel">
                                <div class="tvm-viewer-list" style="margin-top: 20px;">
                                    <div class="tvm-pagination tvm-pagination-top" id="tvm-pagination-top"
                                        style="display: none; margin-bottom: 10px;">
                                        <button id="tvm-prev-top" class="tvm-btn tvm-btn-small">Previous</button>
                                        <span id="tvm-page-info-top">Page 1 of 1</span>
                                        <button id="tvm-next-top" class="tvm-btn tvm-btn-small">Next</button>
                                    </div>

                                    <div class="tvm-list-header">
                                        <input type="text" id="tvm-search" placeholder="Search viewers..."
                                            class="tvm-search">
                                        <select id="tvm-sort" class="tvm-select">
                                            <option value="timeInStream">Sort by Time</option>
                                            <option value="username">Sort by Username</option>
                                            <option value="createdAt">Sort by Created Date</option>
                                        </select>
                                        <select id="tvm-date-filter" class="tvm-select">
                                            <option value="all">All Dates</option>
                                        </select>
                                    </div>

                                    <div class="tvm-list-content" id="tvm-list-content"
                                        style="max-height: none; overflow: visible;">
                                        <p class="tvm-empty">No viewers tracked yet</p>
                                    </div>

                                    <div class="tvm-pagination" id="tvm-pagination" style="display: none;">
                                        <button id="tvm-prev" class="tvm-btn tvm-btn-small">Previous</button>
                                        <span id="tvm-page-info">Page 1 of 1</span>
                                        <button id="tvm-next" class="tvm-btn tvm-btn-small">Next</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Settings Tab -->
                            <div id="tvm-tab-settings" class="tvm-tab-panel">
                                <div class="tvm-columns"
                                    style="display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap;">
                                    <!-- Left Column: Settings (75% width) -->
                                    <div class="tvm-settings-column" style="flex: 3; min-width: 400px; max-width: 75%;">
                                        <div class="tvm-settings" style="margin-bottom: 20px; margin-top: 0;">
                                            <div class="tvm-settings-panel" style="margin-top: 0;">
                                                <div style="margin-bottom: 20px;">
                                                    <label
                                                        style="display: flex; align-items: flex-start; gap: 8px; margin-bottom: 8px;">
                                                        <input type="checkbox" id="tvm-auto-adjust-request-interval">
                                                        <div>
                                                            Auto-adjust request interval based on authenticated users
                                                            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                                                &lt;1000 users: 5s, &lt;5000 users: 2s, 5000+ users: 1s
                                                            </div>
                                                            <div id="tvm-effective-request-interval"
                                                                style="font-size: 12px; color: #00ff88; margin-top: 5px; font-weight: bold; display: none;">
                                                                Current effective interval: <span
                                                                    id="tvm-effective-request-interval-value">--</span>
                                                                seconds
                                                            </div>
                                                        </div>
                                                    </label>
                                                    <div style="margin-left: 24px;">
                                                        <label style="display: block; margin-bottom: 4px;">Request
                                                            Interval (seconds):</label>
                                                        <input type="number" id="tvm-interval" min="1" max="60"
                                                            value="5" style="width: 120px;">
                                                    </div>
                                                </div>

                                                <div style="margin-bottom: 20px;">
                                                    <label
                                                        style="display: flex; align-items: flex-start; gap: 8px; margin-bottom: 8px;">
                                                        <input type="checkbox" id="tvm-auto-adjust-timeout">
                                                        <div>
                                                            Auto-adjust timeout based on authenticated users
                                                            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                                                Optimized for concurrent API processing: 30s-2min based
                                                                on viewer count
                                                            </div>
                                                            <div id="tvm-effective-timeout"
                                                                style="font-size: 12px; color: #00ff88; margin-top: 5px; font-weight: bold; display: none;">
                                                                Current effective timeout: <span
                                                                    id="tvm-effective-timeout-value">--</span> minutes
                                                            </div>
                                                        </div>
                                                    </label>
                                                    <div style="margin-left: 24px;">
                                                        <label style="display: block; margin-bottom: 4px;">Timeout
                                                            Duration (minutes):</label>
                                                        <input type="number" id="tvm-timeout" min="5" max="60"
                                                            value="10" style="width: 120px;">
                                                    </div>
                                                </div>

                                                <div style="margin-bottom: 20px;">
                                                    <label style="display: flex; align-items: flex-start; gap: 8px;">
                                                        <input type="checkbox" id="tvm-auto-pause-graphs">
                                                        <div>
                                                            Auto-pause graphs when viewer count is 0
                                                            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                                                Automatically pauses graph updates after 5 minutes when
                                                                viewer count reaches 0
                                                            </div>
                                                        </div>
                                                    </label>
                                                </div>

                                                <div style="margin-bottom: 20px;">
                                                    <label style="display: flex; align-items: flex-start; gap: 8px;">
                                                        <input type="checkbox" id="tvm-clean-graph-zero-data">
                                                        <div>
                                                            Clean graph data
                                                            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                                                Remove excessive zero viewer data from graph start
                                                                (keeps only 5 minutes)
                                                            </div>
                                                        </div>
                                                    </label>
                                                </div>

                                                <div style="margin-bottom: 20px;">
                                                    <label style="display: block; margin-bottom: 8px;">
                                                        History Retention (hours)
                                                        <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                                            How long to keep graph history data (1-72 hours)
                                                        </div>
                                                    </label>
                                                    <input type="number" id="tvm-history-retention" min="1" max="72"
                                                        value="12" style="width: 120px;">
                                                </div>

                                                <div style="display: flex; gap: 10px; align-items: center;">
                                                    <button id="tvm-reset-settings"
                                                        class="tvm-btn tvm-btn-secondary">Reset to Defaults</button>
                                                    <button id="tvm-save-settings" class="tvm-btn tvm-btn-primary">Save
                                                        Settings</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right Column: Debug Info (25% width) -->
                                    <div class="tvm-debug-column" style="flex: 1; min-width: 200px; max-width: 25%;">
                                        <div class="tvm-debug" style="font-size: 12px; color: #666;">
                                            <div id="tvm-debug-panel"
                                                style="padding: 10px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                                                <div id="tvm-debug-content">Loading...</div>
                                            </div>
                                        </div>

                                        <!-- Export Panel - Tracking Data -->
                                        <div class="tvm-settings" style="margin-top: 20px;">
                                            <div class="tvm-settings-panel">
                                                <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #efeff1;">Export
                                                    Tracking Data</h3>
                                                <div style="font-size: 12px; color: #adadb8; margin-bottom: 15px;">
                                                    Export viewer tracking histogram data including channel, username,
                                                    ID,
                                                    creation date, first seen, last seen, and time in stream.
                                                </div>
                                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                                    <button id="tvm-export-csv" class="tvm-btn tvm-btn-primary">
                                                        Export as CSV
                                                    </button>
                                                    <button id="tvm-export-xml" class="tvm-btn tvm-btn-primary">
                                                        Export as XML
                                                    </button>
                                                    <button id="tvm-export-sql" class="tvm-btn tvm-btn-primary">
                                                        Export as SQL
                                                    </button>
                                                    <button id="tvm-export-json" class="tvm-btn tvm-btn-primary">
                                                        Export as JSON
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Export Panel - Viewer Graph -->
                                        <div class="tvm-settings" style="margin-top: 20px;">
                                            <div class="tvm-settings-panel">
                                                <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #efeff1;">Export
                                                    Viewer Graph Data</h3>
                                                <div style="font-size: 12px; color: #adadb8; margin-bottom: 15px;">
                                                    Export viewer graph history including channel, timestamp, total
                                                    viewers, total authenticated, authenticated users (non-bots), and
                                                    authenticated bots.
                                                </div>
                                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                                    <button id="tvm-export-graph-csv" class="tvm-btn tvm-btn-primary">
                                                        Export as CSV
                                                    </button>
                                                    <button id="tvm-export-graph-xml" class="tvm-btn tvm-btn-primary">
                                                        Export as XML
                                                    </button>
                                                    <button id="tvm-export-graph-sql" class="tvm-btn tvm-btn-primary">
                                                        Export as SQL
                                                    </button>
                                                    <button id="tvm-export-graph-json" class="tvm-btn tvm-btn-primary">
                                                        Export as JSON
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Export/Import Panel - Full State -->
                                        <div class="tvm-settings" style="margin-top: 20px;">
                                            <div class="tvm-settings-panel">
                                                <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #efeff1;">Session
                                                    Save & Load</h3>
                                                <div style="font-size: 12px; color: #adadb8; margin-bottom: 15px;">
                                                    Save complete session for later analysis or load a previously saved
                                                    session. Import stops tracking and enters read-only analysis mode.
                                                </div>
                                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                                    <button id="tvm-export-full-state" class="tvm-btn tvm-btn-primary">
                                                        Save Session
                                                    </button>
                                                    <button id="tvm-import-full-state"
                                                        class="tvm-btn tvm-btn-secondary">
                                                        Load Session
                                                    </button>
                                                    <input type="file" id="tvm-import-file-input" accept=".json"
                                                        style="display: none;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../lib/chart.umd.min.js"></script>
    <script src="../lib/chartjs-adapter-date-fns.min.js"></script>
    <script src="../shared/timeout-utils.js"></script>
    <script src="../content/core/settings-manager.js"></script>
    <script src="../content/core/error-handler.js"></script>
    <script src="../content/services/api-client.js"></script>
    <script src="../content/services/export-manager.js"></script>
    <script src="../content/services/enhanced-data-manager.js"></script>
    <script src="../content/utils/format-utils.js"></script>
    <script src="../content/utils/dom-utils.js"></script>
    <script src="../content/utils/color-utils.js"></script>
    <script src="../content/ui/html-templates.js"></script>
    <script src="../content/charts/chart-utils.js"></script>
    <script src="../content/charts/main-chart.js"></script>
    <script src="../content/charts/creation-chart.js"></script>
    <script src="../content/charts/heatmap-chart.js"></script>
    <script src="../content/charts/chart-manager.js"></script>
    <script src="../content/managers/stats-manager.js"></script>
    <script src="../content/managers/viewer-list-manager.js"></script>
    <script src="../content/managers/debug-manager.js"></script>
    <script src="../content/ui/popup-manager.js"></script>
    <script src="../content/ui/tab-manager.js"></script>
    <script src="../content/ui/settings-ui.js"></script>
    <script src="../content/ui/ui-manager.js"></script>
    <script src="tracking.js"></script>
</body>

</html>